<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Caixa v24.12 (Final e Corrigido) - Congregação Cristã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .campo-condicional { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .campo-condicional.visivel { max-height: 200px; }
        .list-item-enter { opacity: 0; transform: translateY(10px); animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .filter-btn-active { background-color: #2563eb; color: white; }
        @media print { @page { size: landscape; margin: 15mm; } body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 0; font-size: 10px; } .no-print { display: none; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 6px; text-align: left;} th, tfoot td { background-color: #f2f2f2; color: #333; font-weight: bold; } .text-right { text-align: right; } .text-red-600 { color: #DC2626 !important; } .text-green-600 { color: #16A34A !important; } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-4"><div class="w-full max-w-sm bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><h1 class="text-2xl font-bold text-center text-blue-600 dark:text-blue-400 mb-2">MOVIMENTAÇÃO DO CAIXA (COFRE)</h1><p class="text-center text-gray-500 dark:text-gray-400 mb-6">Congregação Cristã - Canaã dos Carajás</p><form id="login-form"><div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">E-mail</label><input type="email" id="email" required class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label><input type="password" id="password" required class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p><button type="submit" id="login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Entrar</button></form></div></div>
    <div class="container mx-auto max-w-4xl p-4 sm:p-6 hidden" id="main-content">
        <header class="flex justify-between items-center mb-4 no-print"><div class="text-left"><h1 class="text-2xl sm:text-3xl font-bold text-blue-600 dark:text-blue-400 uppercase">Controle das Movimentações do Caixa</h1><p id="user-display-name" class="text-sm sm:text-md text-gray-500 dark:text-gray-400"></p></div><div class="flex items-center gap-2"><button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm"><ion-icon name="log-out-outline"></ion-icon><span class="hidden sm:inline">SAIR</span></button></div></header>
        <div id="transactions-view">
            <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md no-print"><label for="month-selector" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecione o Mês:</label><input type="month" id="month-selector" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2"></div>
            <div id="alerts-section" class="space-y-4 mb-8 no-print"><div id="deposit-alert-card" class="hidden bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 p-4 rounded-r-lg shadow-md flex items-center"><ion-icon name="shield-half-outline" class="text-4xl text-red-500 mr-4 flex-shrink-0"></ion-icon><div class="flex-grow"><div class="flex justify-between items-center"><h3 class="font-bold text-red-800 dark:text-red-300">ATENÇÃO: VALOR ELEVADO EM CAIXA</h3><span id="deposit-days-ago" class="text-sm font-semibold text-red-700 dark:text-red-400 whitespace-nowrap ml-4"></span></div><p class="text-red-700 dark:text-red-400 text-sm mt-1 uppercase">Prezados irmãos, por segurança, orientamos que seja efetuado o depósito bancário o mais breve possível.</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div id="entry-confirmation-alert-card" class="hidden bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg shadow-md flex items-center"><ion-icon name="help-circle-outline" class="text-3xl text-blue-500 mr-4"></ion-icon><div><div class="font-semibold text-blue-800 dark:text-blue-300">Confirmação de Entrada Pendente</div><p class="text-blue-700 dark:text-blue-400 text-sm mt-1">Existem <span id="entry-confirmation-count" class="font-bold">0</span> entradas aguardando.</p></div></div><div id="approval-alert-card" class="hidden bg-orange-100 dark:bg-orange-900/50 p-4 rounded-lg shadow-md flex items-center"><ion-icon name="time-outline" class="text-3xl text-orange-500 mr-4"></ion-icon><div><div class="font-semibold text-orange-800 dark:text-orange-300">Aprovações de Saída Pendentes</div><p class="text-orange-700 dark:text-orange-400 text-sm mt-1">Existem <span id="approval-count" class="font-bold">0</span> solicitações aguardando.</p></div></div><div id="prestacao-alert-card" class="hidden bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-lg shadow-md flex items-center"><ion-icon name="receipt-outline" class="text-3xl text-yellow-500 mr-4"></ion-icon><div><div class="font-semibold text-yellow-800 dark:text-yellow-300">Prestar Contas</div><p class="text-yellow-700 dark:text-yellow-400 text-sm mt-1">Você tem <span id="prestacao-count" class="font-bold">0</span> saídas para prestar contas.</p></div></div></div></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 no-print"><div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg shadow"><h3 class="font-medium text-green-800 dark:text-green-300">Entradas do Mês</h3><p id="total-entradas" class="text-2xl font-semibold text-green-600 dark:text-green-400">R$ 0,00</p></div><div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-lg shadow"><h3 class="font-medium text-red-800 dark:text-red-300">Saídas do Mês</h3><p id="total-saidas" class="text-2xl font-semibold text-red-600 dark:text-red-400">R$ 0,00</p></div><div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg shadow"><h3 class="font-medium text-blue-800 dark:text-blue-300">Saldo Atual</h3><p id="saldo-mes" class="text-2xl font-semibold text-blue-600 dark:text-blue-400">R$ 0,00</p></div></div>
            <div class="flex flex-col sm:flex-row gap-4 mb-8 no-print"><button onclick="window.openModal('entrada')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow flex items-center justify-center gap-2"><ion-icon name="add-circle-outline" class="text-2xl"></ion-icon>REGISTRAR ENTRADA</button><button onclick="window.openModal('saida')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow flex items-center justify-center gap-2"><ion-icon name="remove-circle-outline" class="text-2xl"></ion-icon>REGISTRAR SAÍDA</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 no-print"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-2 flex items-center gap-2"><ion-icon name="construct-outline"></ion-icon>Configurações</h2><p class="text-gray-600 dark:text-gray-400 mb-4">Use para definir o primeiro saldo do caixa.</p><div class="flex justify-end"><button onclick="window.openInitialBalanceModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2"><ion-icon name="cash-outline"></ion-icon>Ajustar Saldo</button></div></div><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold mb-2 flex items-center gap-2"><ion-icon name="analytics-outline"></ion-icon>RELATÓRIOS</h2><p class="text-gray-600 dark:text-gray-400 mb-4">Acesse para filtros avançados e impressão.</p><div class="flex justify-end"><button onclick="window.showReportView()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2"><ion-icon name="arrow-forward-circle-outline"></ion-icon>Acessar</button></div></div></div>
            <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md no-print"><h2 id="transactions-title" class="text-xl font-bold mb-4 border-b pb-2 flex items-center gap-2"><ion-icon name="list-outline"></ion-icon>Lançamentos do Mês</h2><div id="filter-buttons" class="flex flex-wrap gap-2 mb-4"><button id="filter-all" class="filter-btn-active flex-1 sm:flex-none py-2 px-4 rounded-lg text-sm font-semibold transition-colors duration-200">Todos</button><button id="filter-entry-confirmation" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 flex-1 sm:flex-none py-2 px-4 rounded-lg text-sm font-semibold transition-colors duration-200">Confirmações Pendentes</button><button id="filter-approval" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 flex-1 sm:flex-none py-2 px-4 rounded-lg text-sm font-semibold transition-colors duration-200">Aprovações Pendentes</button><button id="filter-prestacao" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 flex-1 sm:flex-none py-2 px-4 rounded-lg text-sm font-semibold transition-colors duration-200">Prestações Pendentes</button></div><div id="transactions-list" class="space-y-4"></div></div>
        </div>
        <div id="report-view" class="hidden"><div class="flex justify-between items-center mb-6 no-print"><h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400">Relatórios Detalhados</h2><button onclick="window.showMainView()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><ion-icon name="arrow-back-outline"></ion-icon> Voltar</button></div><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8 no-print"><h3 class="text-xl font-bold mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Filtros</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"><div><label for="reportStartDate" class="block text-sm font-medium">Data de Início</label><input type="date" id="reportStartDate" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div><label for="reportEndDate" class="block text-sm font-medium">Data de Fim</label><input type="date" id="reportEndDate" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div><label for="reportType" class="block text-sm font-medium">Tipo</label><select id="reportType" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"><option value="todos">Todos</option><option value="entradas">Entradas</option><option value="saidas">Saídas</option></select></div><div><label id="reportCategoryLabel" for="reportCategory" class="block text-sm font-medium">Categoria (Saídas)</label><select id="reportCategory" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2" disabled><option value="todas">Todas</option></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div><label for="reportSupplier" class="block text-sm font-medium">Fornecedor</label><input type="text" id="reportSupplier" placeholder="Digite parte do nome..." class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div></div><div class="flex justify-end gap-3"><button onclick="window.printReport()" id="printReportBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2 hidden"><ion-icon name="print-outline"></ion-icon>Imprimir</button><button onclick="window.generateDetailedReport()" id="generateReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2"><ion-icon name="filter-outline"></ion-icon>Filtrar</button></div></div><div id="print-area"><div id="report-output" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md"><p class="text-center text-gray-500">Use os filtros acima para gerar um relatório.</p></div></div></div>
    </div>
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md p-6 overflow-y-auto max-h-screen"><h2 id="modalTitle" class="text-2xl font-bold mb-6 text-center"></h2><form id="transactionForm" onsubmit="window.saveTransaction(event)"><input type="hidden" id="editTransactionId"><input type="hidden" id="transactionType"><div class="mb-4"><label for="date" class="block text-sm font-medium">Data</label><input type="date" id="date" required class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-4"><label for="amount" class="block text-sm font-medium">Valor (R$)</label><input type="number" id="amount" required placeholder="Ex: 250.50" step="0.01" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div id="entryOriginFields" class="hidden space-y-4"><div><label for="casaOracaoSelect" class="block text-sm font-medium">Casa de Oração</label><select id="casaOracaoSelect" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"><option value="">Selecione...</option><option value="CORDEIRO NETO">CORDEIRO NETO</option><option value="GONZAGUINHA">GONZAGUINHA</option><option value="NOVO BRASIL">NOVO BRASIL</option><option value="NOVO HORIZONTE">NOVO HORIZONTE</option><option value="VILA JERUSALÉM">VILA JERUSALÉM</option><option value="VILA PLANALTO">VILA PLANALTO</option><option value="JARDIM BELA VISTA">JARDIM BELA VISTA</option></select></div><div id="tipoColetaContainer" class="campo-condicional"><label for="tipoColetaSelect" class="block text-sm font-medium">Tipo de Coleta</label><select id="tipoColetaSelect" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"><option value="Culto Oficial">Culto Oficial</option><option value="RJM">RJM</option></select></div></div><div id="exitReasonField" class="hidden space-y-4"><div><label for="centroCustoSelect" class="block text-sm font-medium">Centro de Custo</label><select id="centroCustoSelect" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"><option value="">Selecione...</option><option value="ADMINISTRATIVO">ADMINISTRATIVO</option><option value="CORDEIRO NETO">CORDEIRO NETO</option><option value="GONZAGUINHA">GONZAGUINHA</option><option value="NOVO BRASIL">NOVO BRASIL</option><option value="NOVO HORIZONTE">NOVO HORIZONTE</option><option value="VILA JERUSALÉM">VILA JERUSALÉM</option><option value="VILA PLANALTO">VILA PLANALTO</option><option value="JARDIM BELA VISTA">JARDIM BELA VISTA</option></select></div><div><label for="description" class="block text-sm font-medium">Descrição da Despesa</label><input type="text" id="description" placeholder="Ex: Compra de 20 lâmpadas LED" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div><label for="categorySelect" class="block text-sm font-medium">Categoria</label><select id="categorySelect" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"><option value="">Selecione a categoria...</option><option value="Depósito Bancário">Depósito Bancário</option><option value="Produtos de Limpeza">Produtos de Limpeza</option><option value="Alimentação">Alimentação</option><option value="Água">Água</option><option value="Energia">Energia</option><option value="Manutenção e Reparos">Manutenção e Reparos</option><option value="Material de Escritório">Material de Escritório</option><option value="Outra">Outra (especificar)</option></select></div><div id="otherCategoryContainer" class="campo-condicional"><label for="otherCategoryInput" class="block text-sm font-medium">Qual categoria?</label><input type="text" id="otherCategoryInput" placeholder="Ex: Viagem Ministerial" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div></div><div class="mt-4 mb-6"><label for="confirmations" class="block text-sm font-medium">Lançado por (seu nome)</label><input type="text" id="confirmations" required placeholder="Seu nome para registro" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="flex justify-end gap-4"><button type="button" onclick="window.closeModal('transactionModal')" class="py-2 px-6 bg-gray-300 dark:bg-gray-600 rounded-md">Cancelar</button><button id="saveButton" type="submit" class="py-2 px-6 bg-blue-600 text-white rounded-md">Salvar</button></div></form></div></div>
    <div id="addExpenseModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md p-6"><h2 class="text-2xl font-bold mb-2 text-center">Adicionar Despesa</h2><p class="text-center text-gray-500 mb-6">Adiantamento: <span id="adiantamentoDesc" class="font-bold"></span></p><form id="addExpenseForm" onsubmit="window.savePartialExpense(event)"><input type="hidden" id="adiantamentoId"><div class="mb-4"><label for="expenseDescription" class="block text-sm font-medium">Descrição da Despesa</label><input type="text" id="expenseDescription" required placeholder="Ex: Almoço de Sábado" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-4"><label for="expenseAmount" class="block text-sm font-medium">Valor Gasto (R$)</label><input type="number" id="expenseAmount" required placeholder="Ex: 50.00" step="0.01" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-4"><label for="expenseSupplier" class="block text-sm font-medium">Nome do Fornecedor/Loja</label><input type="text" id="expenseSupplier" required placeholder="Ex: Restaurante Central" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-4"><label for="expenseDate" class="block text-sm font-medium">Data da Compra</label><input type="date" id="expenseDate" required class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-6"><label for="expenseAttachment" class="block text-sm font-medium">Anexar Comprovante (Opcional)</label><input type="file" id="expenseAttachment" accept="image/*,application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div><div class="flex justify-end gap-4"><button type="button" onclick="window.closeModal('addExpenseModal')" class="py-2 px-6 bg-gray-300 dark:bg-gray-600 rounded-md">Cancelar</button><button id="saveExpenseButton" type="submit" class="py-2 px-6 bg-blue-600 text-white rounded-md">Adicionar Despesa</button></div></form></div></div>
    <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-[60] no-print"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm p-6"><h2 class="text-2xl font-bold mb-2 text-center">Bem-vindo(a)!</h2><p class="text-center text-gray-600 dark:text-gray-400 mb-6">Por favor, informe seu nome para personalizar o sistema.</p><form id="nameForm" onsubmit="window.saveUserName(event)"><div class="mb-6"><label for="userNameInput" class="block text-sm font-medium">Seu Nome</label><input type="text" id="userNameInput" required placeholder="Ex: João da Silva" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><button id="saveNameButton" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Nome</button></form></div></div>
    <div id="initialBalanceModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-md p-6"><h2 class="text-2xl font-bold mb-2 text-center">Ajustar Saldo Inicial</h2><p class="text-center text-gray-500 mb-6">Este valor será a base para todos os cálculos futuros.</p><form id="initialBalanceForm" onsubmit="window.saveInitialBalance(event)"><div class="mb-4"><label for="initialBalanceAmount" class="block text-sm font-medium">Valor do Saldo Inicial (R$)</label><input type="number" id="initialBalanceAmount" required placeholder="Ex: 5000.00" step="0.01" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"></div><div class="mb-6"><label for="initialBalanceDate" class="block text-sm font-medium">Data do Saldo Inicial</label><input type="date" id="initialBalanceDate" required class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2"><p class="text-xs text-gray-500 mt-1">Use a primeira data do período. Ex: 01/07/2025.</p></div><div class="flex justify-end gap-4"><button type="button" onclick="window.closeModal('initialBalanceModal')" class="py-2 px-6 bg-gray-300 dark:bg-gray-600 rounded-md">Cancelar</button><button id="saveInitialBalanceButton" type="submit" class="py-2 px-6 bg-purple-600 text-white rounded-md">Salvar Saldo</button></div></form></div></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, addDoc, arrayUnion, serverTimestamp, getDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

      const firebaseConfig = { apiKey: "AIzaSyAq76GYmmM4LXDzzYEyf-tF5XUvttLkC5g", authDomain: "controle-caixa-ccb-canaa.firebaseapp.com", projectId: "controle-caixa-ccb-canaa", storageBucket: "controle-caixa-ccb-canaa.appspot.com", messagingSenderId: "1059927223587", appId: "1:1059927223587:web:d1e10e99e26e8195393096", measurementId: "G-WYNRD6BP5J" };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);
      
      const loginScreen = document.getElementById('login-screen'); const mainContent = document.getElementById('main-content'); const transactionsView = document.getElementById('transactions-view'); const reportView = document.getElementById('report-view');
      let currentUserName = ''; let allTransactions = []; let currentFilter = 'all';
      const casasDeOracao = ["CORDEIRO NETO", "GONZAGUINHA", "NOVO BRASIL", "NOVO HORIZONTE", "VILA JERUSALÉM", "VILA PLANALTO", "JARDIM BELA VISTA"];

      onAuthStateChanged(auth, async (user) => { if (user) { const userRef = doc(db, "users", user.uid); const docSnap = await getDoc(userRef); let userData = docSnap.data(); loginScreen.classList.add('hidden'); if (!docSnap.exists() || !userData?.name) { document.getElementById('nameModal').classList.add('flex'); document.getElementById('nameModal').classList.remove('hidden'); if (!docSnap.exists()) { await setDoc(userRef, { email: user.email }); } } else { initializeAppUI(userData.name); } } else { loginScreen.classList.remove('hidden'); mainContent.classList.add('hidden'); } });
      window.saveUserName = async (event) => { event.preventDefault(); const btn = document.getElementById('saveNameButton'); btn.disabled = true; btn.innerText = "Salvando..."; const name = document.getElementById('userNameInput').value.trim(); if (name && auth.currentUser) { const userRef = doc(db, "users", auth.currentUser.uid); try { await updateDoc(userRef, { name: name }); document.getElementById('nameModal').classList.add('hidden'); document.getElementById('nameModal').classList.remove('flex'); initializeAppUI(name); } catch (error) { console.error("Erro ao salvar o nome: ", error); alert("Não foi possível salvar seu nome. Tente novamente."); btn.disabled = false; btn.innerText = "Salvar Nome"; } } };
      function initializeAppUI(userName) { currentUserName = userName; document.getElementById('user-display-name').innerText = `Paz de Deus, Irmão. ${currentUserName.toUpperCase()}`; document.getElementById('confirmations').value = currentUserName; mainContent.classList.remove('hidden'); setInitialMonth(); startLiveUpdates(); }
      document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = e.target['email'].value; const password = e.target['password'].value; const btn = document.getElementById('login-button'); const err = document.getElementById('login-error'); btn.disabled = true; btn.innerText = "Entrando..."; err.classList.add('hidden'); signInWithEmailAndPassword(auth, email, password).catch(() => { err.innerText = "E-mail ou senha inválidos."; err.classList.remove('hidden'); }).finally(() => { btn.disabled = false; btn.innerText = "Entrar"; }); });
      document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
      const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
      const formatDate = (dateString) => { if (!dateString) return 'N/A'; return new Date(dateString + "T00:00:00").toLocaleDateString('pt-BR'); };
      const monthSelector = document.getElementById('month-selector');
      let unsubscribe; 

      function startLiveUpdates() { const q = query(collection(db, "transacoes"), orderBy("createdAt", "desc")); unsubscribe = onSnapshot(q, () => { updateAllData(); }); }
      async function updateAllData() { const allDocsSnapshot = await getDocs(query(collection(db, "transacoes"), orderBy("date", "desc"), orderBy("createdAt", "desc"))); allTransactions = allDocsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data()})); updateUIForCurrentMonth(); }
      function updateUIForCurrentMonth() { const yearMonth = monthSelector.value; if(!yearMonth) return; const monthTransactions = allTransactions.filter(t => t.date.startsWith(yearMonth)); let saldoAnterior = 0; allTransactions.filter(t => t.date < `${yearMonth}-01`).forEach(t => { if(t.status !== 'pendente_aprovacao' && t.status !== 'pendente_confirmacao') { saldoAnterior += t.amount; } }); let totalEntradasMes = 0; let totalSaidasMes = 0; monthTransactions.forEach(t => { if (t.amount >= 0 && (t.status === 'aprovada' || (t.type === 'ajuste_saldo' && t.status === 'concluido'))) { totalEntradasMes += t.amount; } else if (t.amount < 0 && (t.status !== 'pendente_aprovacao')) { totalSaidasMes += t.amount; } }); const saldoFinalMes = saldoAnterior + totalEntradasMes + totalSaidasMes; document.getElementById('total-entradas').innerText = formatCurrency(totalEntradasMes); document.getElementById('total-saidas').innerText = formatCurrency(totalSaidasMes); document.getElementById('saldo-mes').innerText = formatCurrency(saldoFinalMes); applyFilterAndRender(monthTransactions); updateAlerts(allTransactions); checkHighBalance(allTransactions); }
      async function checkHighBalance(transactions) { let runningBalance = 0; let firstDateAbove = null; const sortedTransactions = [...transactions].sort((a,b) => new Date(a.date) - new Date(b.date)); for (const transaction of sortedTransactions) { if(transaction.status !== 'pendente_aprovacao' && transaction.status !== 'pendente_confirmacao') { runningBalance += transaction.amount; } if (runningBalance > 5000) { if (firstDateAbove === null) { firstDateAbove = new Date(transaction.date + "T00:00:00"); } } else { firstDateAbove = null; } } const depositAlertCard = document.getElementById('deposit-alert-card'); if (firstDateAbove) { const today = new Date(); today.setHours(0, 0, 0, 0); const diffTime = Math.abs(today - firstDateAbove); const diffDays = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24))); document.getElementById('deposit-days-ago').textContent = `Há ${diffDays} dia(s)`; depositAlertCard.classList.remove('hidden'); } else { depositAlertCard.classList.add('hidden'); } }
      function applyFilterAndRender(transactions) { let filteredTransactions = transactions; if (currentFilter === 'entry-confirmation') { filteredTransactions = transactions.filter(t => t.status === 'pendente_confirmacao'); } else if (currentFilter === 'approval') { filteredTransactions = transactions.filter(t => t.status === 'pendente_aprovacao'); } else if (currentFilter === 'prestacao') { filteredTransactions = transactions.filter(t => t.status === 'pendente_prestacao'); } renderTransactionList(filteredTransactions); updateFilterButtons(); }
      function renderTransactionList(transactions) { const container = document.getElementById('transactions-list'); container.innerHTML = ''; const parentTransactions = transactions.filter(t => !t.relatedTransaction || t.type === 'saida'); const childTransactions = allTransactions.filter(t => t.relatedTransaction); if (parentTransactions.length === 0) { container.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum lançamento encontrado para este filtro.</p>`; return; } parentTransactions.forEach(t => { const isEntrada = t.amount >= 0; const isPendenteConfirmacao = t.status === 'pendente_confirmacao'; const isPendenteAprovacao = t.status === 'pendente_aprovacao'; const isPendentePrestacao = t.status === 'pendente_prestacao'; const isConcluido = t.status === 'concluido'; const isEstornada = t.status === 'estornada'; let borderColor = 'border-gray-300'; if (isPendenteConfirmacao) borderColor = 'border-blue-500'; else if (isEntrada) borderColor = 'border-green-500'; else if (isPendenteAprovacao) borderColor = 'border-orange-500'; else if (isPendentePrestacao) borderColor = 'border-yellow-500'; else if (isEstornada) borderColor = 'border-gray-400'; else borderColor = 'border-red-500'; let iconName = 'ellipse'; if (isPendenteConfirmacao) iconName = 'help-circle-outline'; else if(t.type === 'ajuste_saldo') iconName = 'flag-outline'; else if (t.type === 'entrada') iconName = 'arrow-up-circle'; else if (t.type === 'estorno') iconName = 'wallet-outline'; else if (t.type === 'saida') { if (isPendenteAprovacao) iconName = 'time-outline'; else if (isPendentePrestacao) iconName = 'receipt-outline'; else if (isConcluido) iconName = 'checkmark-circle-outline'; else if (isEstornada) iconName = 'close-circle-outline'; else iconName = 'arrow-down-circle'; } let categoryHTML = t.category ? `<p class="text-sm text-gray-500 mt-1">Categoria: <span class="font-medium">${t.category}</span></p>` : ''; let footerHTML = ''; const createdByMe = t.createdBy && t.createdBy.uid === auth.currentUser.uid; if (isPendenteConfirmacao) { footerHTML = `<div class="mt-2 flex justify-between items-center"><span class="text-xs font-semibold bg-blue-200 text-blue-800 px-2 py-1 rounded-full">Aguardando Confirmação</span><div>`; if (!createdByMe) { footerHTML += `<button onclick="window.confirmEntry('${t.id}')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded">Confirmar</button>`; } if (createdByMe) { footerHTML += `<button onclick="window.openEditModal('${t.id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded ml-2">Editar</button><button onclick="window.cancelWithdrawal('${t.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded ml-2">Cancelar</button>`; } footerHTML += `</div></div>`; } else if (isPendenteAprovacao) { footerHTML = `<div class="mt-2 flex justify-between items-center"><span class="text-xs font-semibold bg-orange-200 text-orange-800 px-2 py-1 rounded-full">Aguardando Aprovação</span><div>`; if (!createdByMe) { footerHTML += `<button onclick="window.approveWithdrawal('${t.id}')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded">Aprovar</button>`; } if (createdByMe) { footerHTML += `<button onclick="window.cancelWithdrawal('${t.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded ml-2">Cancelar</button>`; } footerHTML += `</div></div>`; } else if (isPendentePrestacao) { let subExpensesHTML = ''; const relatedExpenses = childTransactions.filter(c => c.relatedTransaction === t.id && c.type === 'despesa_parcial'); let totalGasto = 0; relatedExpenses.forEach(exp => { totalGasto += Math.abs(exp.amount); subExpensesHTML += `<div class="flex justify-between items-center mt-1 pl-4 border-l-2 border-gray-200 dark:border-gray-600"><p class="text-sm">${exp.description}</p><p class="text-sm font-semibold">${formatCurrency(exp.amount)}</p></div>`; }); const valorRestante = Math.abs(t.amount) - totalGasto; footerHTML = `<div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">${subExpensesHTML}<div class="mt-2 text-right text-sm font-semibold">Total Gasto: ${formatCurrency(totalGasto)} / Restante: ${formatCurrency(valorRestante)}</div><div class="mt-2 flex justify-end gap-2"><button onclick="window.openAddExpenseModal('${t.id}', '${t.description}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded">Adicionar Despesa</button><button onclick="window.finalizeAccountability('${t.id}', ${t.amount})" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded">Finalizar Contas</button></div></div>`; } else if (isConcluido && t.type === 'saida') { let subExpensesHTML = ''; const relatedExpenses = childTransactions.filter(c => c.relatedTransaction === t.id); if(relatedExpenses.length > 0) { subExpensesHTML = '<div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 space-y-1">'; relatedExpenses.forEach(exp => { let attachmentLink = exp.attachmentUrl ? ` <a href="${exp.attachmentUrl}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-1"><ion-icon name="attach-outline"></ion-icon></a>` : ''; subExpensesHTML += `<div class="flex justify-between items-center pl-4 border-l-2 border-gray-200 dark:border-gray-600"><p class="text-sm flex items-center">${exp.description}${attachmentLink}</p><p class="text-sm font-semibold ${exp.amount > 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(exp.amount)}</p></div>`; }); subExpensesHTML += '</div>'; } footerHTML = subExpensesHTML; } const launchedBy = t.createdBy?.name?.toUpperCase() || (Array.isArray(t.confirmedBy) ? t.confirmedBy[0].toUpperCase() : ''); const confirmedByDisplay = (t.confirmedBy?.length > 1) ? t.confirmedBy.slice(1).join(', ').toUpperCase() : (t.status === 'aprovada' && !isPendenteConfirmacao ? (t.confirmedBy[0]?.toUpperCase() || '') : ''); let transactionHTML = `<div class="p-4 border-l-4 ${borderColor} bg-gray-50 dark:bg-gray-800/50 rounded-r-lg list-item-enter"><div class="flex items-start"><div class="flex-shrink-0 text-gray-500 pt-1"><ion-icon name="${iconName}" class="text-3xl"></ion-icon></div><div class="ml-4 flex-1"><div class="flex justify-between items-center"><p class="font-semibold text-lg">${t.description}</p><p class="font-bold text-lg ${isEntrada ? 'text-green-600' : 'text-red-600'}">${formatCurrency(t.amount)}</p></div><p class="text-sm text-gray-500">Data: ${formatDate(t.date)}</p>${categoryHTML}<p class="text-sm text-gray-500 mt-1">Lançado por: ${launchedBy}</p>${(confirmedByDisplay && !isPendenteConfirmacao && !isPendenteAprovacao) ? `<p class="text-sm text-gray-500 mt-1">Confirmado por: ${confirmedByDisplay}</p>` : ''}${footerHTML}</div></div></div>`; container.innerHTML += transactionHTML; }); }
      function updateAlerts(transactions) { const entryConfirmationCard = document.getElementById('entry-confirmation-alert-card'); const entryConfirmationCount = document.getElementById('entry-confirmation-count'); const approvalCard = document.getElementById('approval-alert-card'); const approvalCount = document.getElementById('approval-count'); const prestacaoCard = document.getElementById('prestacao-alert-card'); const prestacaoCount = document.getElementById('prestacao-count'); const pendingEntry = transactions.filter(t => t.status === 'pendente_confirmacao'); const pendingApproval = transactions.filter(t => t.status === 'pendente_aprovacao'); const pendingPrestacao = transactions.filter(t => t.status === 'pendente_prestacao'); if (pendingEntry.length > 0) { entryConfirmationCount.textContent = pendingEntry.length; entryConfirmationCard.classList.remove('hidden'); } else { entryConfirmationCard.classList.add('hidden'); } if (pendingApproval.length > 0) { approvalCount.textContent = pendingApproval.length; approvalCard.classList.remove('hidden'); } else { approvalCard.classList.add('hidden'); } if (pendingPrestacao.length > 0) { prestacaoCount.textContent = pendingPrestacao.length; prestacaoCard.classList.remove('hidden'); } else { prestacaoCard.classList.add('hidden'); } }
      function updateFilterButtons() { document.querySelectorAll('#filter-buttons button').forEach(btn => { btn.classList.remove('filter-btn-active'); btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300'); }); const activeBtn = document.getElementById(`filter-${currentFilter}`); if (activeBtn) { activeBtn.classList.add('filter-btn-active'); activeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300'); } }
      document.getElementById('filter-all').addEventListener('click', () => { currentFilter = 'all'; updateUIForCurrentMonth(); });
      document.getElementById('filter-entry-confirmation').addEventListener('click', () => { currentFilter = 'entry-confirmation'; updateUIForCurrentMonth(); });
      document.getElementById('filter-approval').addEventListener('click', () => { currentFilter = 'approval'; updateUIForCurrentMonth(); });
      document.getElementById('filter-prestacao').addEventListener('click', () => { currentFilter = 'prestacao'; updateUIForCurrentMonth(); });
      monthSelector.addEventListener('change', () => { if (monthSelector.value) { currentFilter = 'all'; updateUIForCurrentMonth(); } });
      function setInitialMonth() { const today = new Date(); const year = today.getFullYear(); const month = (today.getMonth() + 1).toString().padStart(2, '0'); monthSelector.value = `${year}-${month}`; updateUIForCurrentMonth(); }
      window.openModal = (type) => { const modal = document.getElementById('transactionModal'); const form = modal.querySelector('form'); form.reset(); document.getElementById('otherCategoryContainer').classList.remove('visivel'); form.querySelector('#editTransactionId').value = ''; form.querySelector('#transactionType').value = type; form.querySelector('#date').value = new Date().toISOString().slice(0, 10); form.querySelector('#confirmations').value = currentUserName; const isEntrada = type === 'entrada'; document.getElementById('entryOriginFields').classList.toggle('hidden', !isEntrada); document.getElementById('exitReasonField').classList.toggle('hidden', isEntrada); document.getElementById('casaOracaoSelect').required = isEntrada; document.getElementById('centroCustoSelect').required = !isEntrada; document.getElementById('description').required = !isEntrada; document.getElementById('categorySelect').required = !isEntrada; modal.querySelector('#modalTitle').innerText = isEntrada ? 'Nova Entrada' : 'Nova Saída'; modal.classList.add('flex'); modal.classList.remove('hidden'); };
      window.closeModal=(t)=>{document.getElementById(t).classList.add("hidden"),document.getElementById(t).classList.remove("flex")};
      window.openInitialBalanceModal = () => { const modal = document.getElementById('initialBalanceModal'); const dateField = document.getElementById('initialBalanceDate'); const today = new Date(); const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0, 10); dateField.value = firstDayOfMonth; modal.classList.add('flex'); modal.classList.remove('hidden'); };
      window.saveInitialBalance = async (event) => { event.preventDefault(); const btn = document.getElementById('saveInitialBalanceButton'); btn.disabled = true; btn.innerText = "Salvando..."; const amount = parseFloat(document.getElementById('initialBalanceAmount').value); const date = document.getElementById('initialBalanceDate').value; if (isNaN(amount) || !date) { alert("Por favor, preencha todos os campos corretamente."); btn.disabled = false; btn.innerText = "Salvar Saldo"; return; } const transactionData = { type: 'ajuste_saldo', status: 'concluido', description: 'SALDO INICIAL DE CAIXA', amount: amount, date: date, createdBy: { uid: auth.currentUser.uid, name: currentUserName }, confirmedBy: [currentUserName.toUpperCase()], createdAt: serverTimestamp(), user: auth.currentUser.email }; try { await addDoc(collection(db, "transacoes"), transactionData); alert("Saldo inicial definido com sucesso!"); window.closeModal('initialBalanceModal'); } catch (e) { console.error("Erro ao salvar saldo inicial:", e); alert("Ocorreu um erro ao salvar. Tente novamente."); } finally { btn.disabled = false; btn.innerText = "Salvar Saldo"; } };
      window.saveTransaction = async (event) => { event.preventDefault(); const btn = document.getElementById('saveButton'); btn.disabled = true; btn.innerText = 'Salvando...'; const form = document.getElementById('transactionForm'); const type = form.querySelector('#transactionType').value; const editId = form.querySelector('#editTransactionId').value; const amount = parseFloat(form.querySelector('#amount').value); const confirmedByText = form.querySelector('#confirmations').value.toUpperCase(); let transactionData = { date: form.querySelector('#date').value, user: auth.currentUser.email, createdBy: { uid: auth.currentUser.uid, name: currentUserName }, confirmedBy: [confirmedByText] }; if (type === 'entrada') { const casa = form.querySelector('#casaOracaoSelect').value; if(!casa) { alert('Selecione a Casa de Oração'); btn.disabled = false; btn.innerText = 'Salvar'; return; } let desc = `COLETA ${casa}`; if (document.getElementById('tipoColetaContainer').classList.contains('visivel')) { desc += ` - ${form.querySelector('#tipoColetaSelect').value.toUpperCase()}`; } Object.assign(transactionData, { type: 'entrada', status: 'pendente_confirmacao', amount: amount, description: desc }); } else { const centroCusto = form.querySelector('#centroCustoSelect').value; const despesaDesc = form.querySelector('#description').value; if (!centroCusto) { alert('Selecione o Centro de Custo.'); btn.disabled = false; btn.innerText = 'Salvar'; return; } if (!despesaDesc) { alert('Informe a Descrição da Despesa.'); btn.disabled = false; btn.innerText = 'Salvar'; return; } const finalDescription = `${centroCusto} - ${despesaDesc.toUpperCase()}`; let category = form.querySelector('#categorySelect').value; if (category === 'Outra') { category = form.querySelector('#otherCategoryInput').value.trim(); if (!category) { alert('Por favor, especifique a categoria "Outra".'); btn.disabled = false; btn.innerText = 'Salvar'; return; } } Object.assign(transactionData, { type: 'saida', status: 'pendente_aprovacao', amount: -amount, description: finalDescription, category: category }); } try { if (editId) { await updateDoc(doc(db, "transacoes", editId), transactionData); } else { transactionData.createdAt = serverTimestamp(); await addDoc(collection(db, "transacoes"), transactionData); } window.closeModal('transactionModal'); } catch (e) { console.error("Erro:", e); alert("Erro ao salvar."); } finally { btn.disabled = false; btn.innerText = 'Salvar'; } };
      window.openEditModal = async (id) => { try { const docRef = doc(db, 'transacoes', id); const docSnap = await getDoc(docRef); if(!docSnap.exists()) { alert('Lançamento não encontrado.'); return; } const data = docSnap.data(); window.openModal(data.type); const form = document.getElementById('transactionForm'); form.querySelector('#editTransactionId').value = id; form.querySelector('#date').value = data.date; form.querySelector('#amount').value = data.amount; form.querySelector('#confirmations').value = Array.isArray(data.confirmedBy) ? data.confirmedBy[0] : data.confirmedBy; if(data.type === 'entrada') { const descParts = data.description.split(' - '); const casa = descParts[0].replace('COLETA ', ''); form.querySelector('#casaOracaoSelect').value = casa; if(descParts.length > 1) { form.querySelector('#tipoColetaContainer').classList.add('visivel'); const tipoColeta = descParts[1].trim().toUpperCase() === 'RJM' ? 'RJM' : 'Culto Oficial'; form.querySelector('#tipoColetaSelect').value = tipoColeta; } } else { const descParts = data.description.split(' - '); form.querySelector('#centroCustoSelect').value = descParts[0].trim(); form.querySelector('#description').value = descParts.slice(1).join(' - ').trim(); form.querySelector('#categorySelect').value = data.category; if(data.category === 'Outra') { form.querySelector('#otherCategoryContainer').classList.add('visivel'); form.querySelector('#otherCategoryInput').value = data.category; } } } catch(e) { console.error("Erro ao carregar para edição:", e); alert('Erro ao carregar dados para edição.'); } };
      window.confirmEntry = async (transactionId) => { if (!confirm("Confirmar esta entrada? A ação não poderá ser desfeita.")) return; const transactionRef = doc(db, "transacoes", transactionId); try { await updateDoc(transactionRef, { status: 'aprovada', confirmedBy: arrayUnion(currentUserName.toUpperCase()) }); alert("Entrada confirmada com sucesso!"); } catch (error) { console.error("Erro ao confirmar entrada:", error); alert("Erro ao confirmar."); } };
      window.approveWithdrawal = async(t)=>{if(!confirm("Aprovar esta saída?"))return;const n=doc(db,"transacoes",t);try{await updateDoc(n,{status:"pendente_prestacao",approvedBy:{uid:auth.currentUser.uid,name:currentUserName},confirmedBy:arrayUnion(currentUserName.toUpperCase())}),alert("Saída aprovada! Aguardando prestação de contas.")}catch(e){console.error("Erro:",e),alert("Erro ao aprovar.")}};
      window.cancelWithdrawal = async(t)=>{if(!confirm("Cancelar esta solicitação?"))return;try{await deleteDoc(doc(db,"transacoes",t)),alert("Solicitação cancelada.")}catch(n){console.error("Erro:",n),alert("Erro ao cancelar.")}};
      window.openAddExpenseModal = (transactionId, description) => { const modal = document.getElementById('addExpenseModal'); const form = modal.querySelector('form'); form.reset(); form.querySelector('#adiantamentoId').value = transactionId; form.querySelector('#adiantamentoDesc').textContent = description; form.querySelector('#expenseDate').value = new Date().toISOString().slice(0, 10); modal.classList.add('flex'); modal.classList.remove('hidden'); };
      window.savePartialExpense = async (event) => { event.preventDefault(); const btn = document.getElementById('saveExpenseButton'); btn.disabled = true; btn.innerText = "Salvando..."; const form = document.getElementById('addExpenseForm'); const parentId = form.querySelector('#adiantamentoId').value; const attachmentFile = form.querySelector('#expenseAttachment').files[0]; let attachmentUrl = null; if (attachmentFile) { const fileRef = ref(storage, `comprovantes/${parentId}/${Date.now()}_${attachmentFile.name}`); try { const snapshot = await uploadBytes(fileRef, attachmentFile); attachmentUrl = await getDownloadURL(snapshot.ref); } catch(e) { console.error("Erro no upload do anexo:", e); alert("Erro ao enviar o anexo. A despesa não foi salva. Verifique sua conexão e o tamanho do arquivo (máx 5MB)."); btn.disabled = false; btn.innerText = "Adicionar Despesa"; return; } } const expenseData = { type: 'despesa_parcial', status: 'concluido', description: form.querySelector('#expenseDescription').value.toUpperCase(), amount: -Math.abs(parseFloat(form.querySelector('#expenseAmount').value)), supplier: form.querySelector('#expenseSupplier').value, date: form.querySelector('#expenseDate').value, relatedTransaction: parentId, confirmedBy: [currentUserName.toUpperCase()], createdAt: serverTimestamp(), user: auth.currentUser.email, attachmentUrl: attachmentUrl }; try { await addDoc(collection(db, "transacoes"), expenseData); alert("Despesa adicionada com sucesso!"); window.closeModal('addExpenseModal'); } catch(e) { console.error("Erro ao salvar despesa parcial: ", e); alert("Ocorreu um erro ao salvar a despesa."); } finally { btn.disabled = false; btn.innerText = "Adicionar Despesa"; } };
      window.finalizeAccountability = async (parentId, parentAmount) => { const q = query(collection(db, "transacoes"), where("relatedTransaction", "==", parentId), where("type", "==", "despesa_parcial")); const childrenSnapshot = await getDocs(q); let totalGasto = 0; childrenSnapshot.forEach(doc => { totalGasto += Math.abs(doc.data().amount); }); const adiantamento = Math.abs(parentAmount); const diferenca = adiantamento - totalGasto; let confirmationMessage = `Você está prestes a finalizar a prestação de contas.\n\nValor do Adiantamento: ${formatCurrency(adiantamento)}\nTotal Gasto: ${formatCurrency(totalGasto)}\n\n`; if (diferenca > 0) { confirmationMessage += `SOBRA de ${formatCurrency(diferenca)} será estornada para o caixa.\n`; } else if (diferenca < 0) { confirmationMessage += `FALTA de ${formatCurrency(Math.abs(diferenca))} e será solicitada como complemento.\n`; } else { confirmationMessage += `As contas fecharam perfeitamente.\n`; } confirmationMessage += `\nDeseja continuar?`; if (!confirm(confirmationMessage)) return; const batch = writeBatch(db); const parentRef = doc(db, "transacoes", parentId); batch.update(parentRef, { status: 'concluido' }); if (diferenca !== 0) { const newTransactionRef = doc(collection(db, "transacoes")); const newTransactionData = { status: diferenca > 0 ? 'pendente_confirmacao' : 'pendente_aprovacao', amount: diferenca, description: `${diferenca > 0 ? 'ESTORNO DE SOBRA' : 'COMPLEMENTO'} DO ADIANTAMENTO`, date: new Date().toISOString().slice(0,10), createdBy: { uid: auth.currentUser.uid, name: currentUserName }, confirmedBy: [currentUserName.toUpperCase()], relatedTransaction: parentId, createdAt: serverTimestamp(), user: auth.currentUser.email, type: diferenca > 0 ? 'estorno' : 'saida' }; batch.set(newTransactionRef, newTransactionData); } try { await batch.commit(); alert("Prestação de contas finalizada com sucesso!"); } catch(e) { console.error("Erro ao finalizar prestação de contas: ", e); alert("Ocorreu um erro ao finalizar."); } };
      document.getElementById('casaOracaoSelect').addEventListener('change', (e) => { const excecoes = ['NOVO BRASIL', 'NOVO HORIZONTE']; document.getElementById('tipoColetaContainer').classList.toggle('visivel', e.target.value && !excecoes.includes(e.target.value)); });
      document.getElementById('categorySelect').addEventListener('change', (e) => { document.getElementById('otherCategoryContainer').classList.toggle('visivel', e.target.value === 'Outra'); document.getElementById('otherCategoryInput').required = (e.target.value === 'Outra'); });
      window.showMainView = () => { document.getElementById('transactions-view').classList.remove('hidden'); document.getElementById('report-view').classList.add('hidden'); };
      window.showReportView = async () => { document.getElementById('transactions-view').classList.add('hidden'); document.getElementById('report-view').classList.remove('hidden'); await updateCategoryFilter(); const today = new Date(); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0,10); const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().slice(0,10); document.getElementById('reportStartDate').value = firstDay; document.getElementById('reportEndDate').value = lastDay; };
      async function updateCategoryFilter() { const reportType = document.getElementById('reportType').value; const categorySelect = document.getElementById('reportCategory'); const categoryLabel = document.getElementById('reportCategoryLabel'); categorySelect.innerHTML = '<option value="todas">Todas</option>'; categorySelect.disabled = true; if (reportType === 'saidas') { categoryLabel.textContent = 'Categoria (Saídas)'; const q = query(collection(db, "transacoes"), where("category", "!=", null)); const querySnapshot = await getDocs(q); const categories = new Set(); querySnapshot.forEach(doc => { if (doc.data().category) categories.add(doc.data().category) }); categories.forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; categorySelect.appendChild(option); }); categorySelect.disabled = false; } else if (reportType === 'entradas') { categoryLabel.textContent = 'Origem (Entradas)'; casasDeOracao.forEach(casa => { const option = document.createElement('option'); option.value = casa; option.textContent = casa; categorySelect.appendChild(option); }); const adminOption = document.createElement('option'); adminOption.value = 'ajuste_saldo'; adminOption.textContent = 'Ajuste de Saldo'; categorySelect.appendChild(adminOption); categorySelect.disabled = false; } else { categoryLabel.textContent = 'Categoria / Origem'; } };
      document.getElementById('reportType').addEventListener('change', updateCategoryFilter);
      window.generateDetailedReport = async () => { const btn = document.getElementById('generateReportBtn'); btn.disabled = true; btn.innerHTML = 'Gerando...'; const startDate = document.getElementById('reportStartDate').value; const endDate = document.getElementById('reportEndDate').value; const typeFilter = document.getElementById('reportType').value; const categoryFilter = document.getElementById('reportCategory').value; const supplierFilter = document.getElementById('reportSupplier').value.toLowerCase(); const output = document.getElementById('report-output'); output.innerHTML = `<p class="text-center text-gray-500 py-4">Calculando saldos e buscando dados...</p>`; if (!startDate || !endDate) { alert("Por favor, selecione as datas de início e fim."); btn.disabled = false; btn.innerHTML = '<ion-icon name="filter-outline"></ion-icon>Filtrar'; return; } const initialBalanceQuery = query(collection(db, "transacoes"), where("date", "<", startDate)); const periodQuery = query(collection(db, "transacoes"), where("date", ">=", startDate), where("date", "<=", endDate), orderBy("date", "asc")); const [initialSnapshot, periodSnapshot] = await Promise.all([ getDocs(initialBalanceQuery), getDocs(periodQuery) ]); let saldoInicial = 0; initialSnapshot.forEach(doc => { saldoInicial += doc.data().amount; }); let transactions = periodSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); if (typeFilter === 'entradas') { transactions = transactions.filter(t => t.amount >= 0); if (categoryFilter !== 'todas') { if (categoryFilter === 'ajuste_saldo') { transactions = transactions.filter(t => t.type === 'ajuste_saldo'); } else { transactions = transactions.filter(t => t.description && t.description.toUpperCase().includes(`COLETA ${categoryFilter}`)); } } } else if (typeFilter === 'saidas') { transactions = transactions.filter(t => t.amount < 0); if (categoryFilter !== 'todas') { transactions = transactions.filter(t => t.category === categoryFilter); } } if (supplierFilter) { transactions = transactions.filter(t => (t.supplier && t.supplier.toLowerCase().includes(supplierFilter)) || (t.prestacaoContas?.fornecedor && t.prestacaoContas.fornecedor.toLowerCase().includes(supplierFilter))); } let totalCreditosPeriodo = 0; let totalDebitosPeriodo = 0; let runningBalance = saldoInicial; let filterDetails = []; if (typeFilter !== 'todos') { filterDetails.push(`<strong>Tipo:</strong> ${document.getElementById('reportType').options[document.getElementById('reportType').selectedIndex].text}`); } if (categoryFilter !== 'todas' && typeFilter !== 'todos') { filterDetails.push(`<strong>${document.getElementById('reportCategoryLabel').textContent}:</strong> ${categoryFilter}`); } if (supplierFilter) { filterDetails.push(`<strong>Fornecedor:</strong> ${supplierFilter}`); } let reportHeaderHTML = ` <div class="mb-6"> <h2 class="text-xl font-bold uppercase">Extrato das Movimentações do Caixa/Cofre</h2> <div class="mt-4 text-sm space-y-1"> <p><strong>Período:</strong> ${formatDate(startDate)} a ${formatDate(endDate)}</p> ${filterDetails.length > 0 ? `<p><strong>Filtros:</strong> ${filterDetails.join(' / ')}</p>` : ''} </div> </div>`; let tableHTML = `<div class="overflow-x-auto"> <table class="min-w-full bg-white dark:bg-gray-800"> <thead> <tr> <th class="py-2 px-4 text-left">Data</th> <th class="py-2 px-4 text-left">Descrição</th> <th class="py-2 px-4 text-left">Categoria</th> <th class="py-2 px-4 text-left">Fornecedor</th> <th class="py-2 px-4 text-right">Crédito</th> <th class="py-2 px-4 text-right">Débito</th> <th class="py-2 px-4 text-right">Saldo</th> </tr> </thead> <tbody> <tr class="border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50"> <td class="py-2 px-4 font-semibold" colspan="4">SALDO INICIAL</td> <td class="py-2 px-4 text-right font-bold" colspan="3">${formatCurrency(saldoInicial)}</td> </tr> `; if (transactions.length === 0) { tableHTML += `<tr><td colspan="7" class="text-center py-4">Nenhum lançamento encontrado para os filtros aplicados.</td></tr>`; } else { transactions.forEach(t => { runningBalance += t.amount; const isEntrada = t.amount >= 0; const creditAmount = isEntrada ? t.amount : 0; const debitAmount = !isEntrada ? Math.abs(t.amount) : 0; totalCreditosPeriodo += creditAmount; totalDebitosPeriodo += debitAmount; let attachmentHTML = ''; if (t.attachmentUrl) { attachmentHTML = ` <a href="${t.attachmentUrl}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-2"><ion-icon name="attach-outline"></ion-icon></a>`; } tableHTML += ` <tr class="border-b dark:border-gray-700"> <td class="py-2 px-4">${formatDate(t.date)}</td> <td class="py-2 px-4 flex items-center">${t.description || 'N/A'}${attachmentHTML}</td> <td class="py-2 px-4">${t.category || 'N/A'}</td> <td class="py-2 px-4">${t.supplier || (t.prestacaoContas?.fornecedor || 'N/A')}</td> <td class="py-2 px-4 text-right font-medium text-green-600">${isEntrada ? formatCurrency(creditAmount) : '-'}</td> <td class="py-2 px-4 text-right font-medium text-red-600">${!isEntrada ? formatCurrency(debitAmount) : '-'}</td> <td class="py-2 px-4 text-right font-semibold">${formatCurrency(runningBalance)}</td> </tr> `; }); } tableHTML += ` </tbody> <tfoot class="bg-gray-100 dark:bg-gray-700 font-bold"> <tr> <td class="py-2 px-4 text-right" colspan="4">TOTAIS DO PERÍODO</td> <td class="py-2 px-4 text-right text-green-600">${formatCurrency(totalCreditosPeriodo)}</td> <td class="py-2 px-4 text-right text-red-600">${formatCurrency(totalDebitosPeriodo)}</td> <td></td> </tr> <tr> <td class="py-2 px-4 text-right" colspan="6">SALDO FINAL</td> <td class="py-2 px-4 text-right">${formatCurrency(runningBalance)}</td> </tr> </tfoot> </table> </div>`; output.innerHTML = reportHeaderHTML + tableHTML; document.getElementById('printReportBtn').classList.remove('hidden'); btn.disabled = false; btn.innerHTML = '<ion-icon name="filter-outline"></ion-icon>Filtrar'; }
      window.printReport = () => { window.print(); }

    </script>
</body>
</html>
